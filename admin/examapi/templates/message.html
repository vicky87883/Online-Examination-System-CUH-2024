<!DOCTYPE html>
<html lang="en">
<head>
{% load static %}

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title -->
    <title> Pheonix AI Chatbot</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'assets/images/logo/favicon.png'%}">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.min.css'%}">
    <!-- file upload -->
    <link rel="stylesheet" href="{% static 'assets/css/file-upload.css'%}">
    <!-- file upload -->
    <link rel="stylesheet" href="{% static 'assets/css/plyr.css'%}">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <!-- full calendar -->
    <link rel="stylesheet" href="{% static 'assets/css/full-calendar.css'%}">
    <!-- jquery Ui -->
    <link rel="stylesheet" href="{% static 'assets/css/jquery-ui.css'%}">
    <!-- editor quill Ui -->
    <link rel="stylesheet" href="{% static 'assets/css/editor-quill.css'%}">
    <!-- apex charts Css -->
    <link rel="stylesheet" href="{% static 'assets/css/apexcharts.css'%}">
    <!-- calendar Css -->
    <link rel="stylesheet" href="{% static 'assets/css/calendar.css'%}">
    <!-- jvector map Css -->
    <link rel="stylesheet" href="{% static 'assets/css/jquery-jvectormap-2.0.5.css'%}">
    <!-- Main css -->
    <link rel="stylesheet" href="{% static 'assets/css/main.css'%}">
</head> 
<body>
    
<!--==================== Preloader Start ====================-->
  <div class="preloader">
    <div class="loader"></div>
  </div>
<!--==================== Preloader End ====================-->

<!--==================== Sidebar Overlay End ====================-->
<div class="side-overlay"></div>
<!--==================== Sidebar Overlay End ====================-->

    <!-- ============================ Sidebar Start ============================ -->

    {% include 'aside.html' %}
   
<!-- ============================ Sidebar End  ============================ -->

<div class="dashboard-main-wrapper">
    {% include 'navbar.html' %}
    
    <div class="dashboard-body">
        <!-- Breadcrumb Start -->
<div class="breadcrumb mb-24">
<ul class="flex-align gap-4">
    <li><a href="index" class="text-gray-200 fw-normal text-15 hover-text-main-600">Home</a></li>
    <li> <span class="text-gray-500 fw-normal d-flex"><i class="ph ph-caret-right"></i></span> </li>
    <li><span class="text-main-600 fw-normal text-15">Message</span></li>
</ul>
</div>
<!-- Breadcrumb End -->
        

        <div class="chart-wrapper d-flex flex-wrap gap-24">
            <!-- chat sidebar Start -->
            
            <!-- chat sidebar End -->

            <!-- chat sidebar Start -->
            <div class="card chat-box">
                <div class="card-header py-16 border-bottom border-gray-100">
                    <div class="chat-list__item flex-between gap-8 cursor-pointer">
                        <div class="d-flex align-items-start gap-16">
                            <div class="position-relative flex-shrink-0">
                                <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0">
                                <span class="activation-badge w-12 h-12 border-2 position-absolute inset-block-end-0 inset-inline-end-0"></span>
                            </div>
                            <div class="d-flex flex-column">
                                <h6 class="text-line-1 text-15 text-gray-400 fw-bold mb-0">Phoenix</h6>
                                <span class="text-line-1 text-13 text-gray-200">Online Chatbot System</span>
                            </div>
                        </div>

                        <div class="flex-align gap-16">
                            <!-- <button type="button" class="text-main-600 text-xl d-flex"><i class="ph-fill ph-phone"></i></button> -->
                            <!-- <button type="button" class="text-main-600 text-xl d-flex"><i class="ph-fill ph-video-camera"></i></button> -->
                            <div class="dropdown flex-shrink-0">
                                <button class="text-gray-400 text-xl d-flex rounded-4" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="ph-fill ph-dots-three-outline-vertical"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu--md border-0 bg-transparent p-0">
                                    <div class="card border border-gray-100 rounded-12 box-shadow-custom">
                                        <div class="card-body p-12">
                                            <div class="max-h-200 overflow-y-auto scroll-sm pe-8">
                                                <ul>
                                                    <li class="mb-0">
                                                        <button type="button" class="delete-item-btn py-6 text-15 px-8 hover-bg-gray-50 text-gray-300 w-100 rounded-8 fw-normal text-xs d-block text-start">
                                                            <span class="text"><i class="ph ph-x-circle"></i> All Clear</span>
                                                        </button>
                                                    </li>
                                                    <li class="mb-0">
                                                        <button type="button" class="delete-item-btn py-6 text-15 px-8 hover-bg-gray-50 text-gray-300 w-100 rounded-8 fw-normal text-xs d-block text-start">
                                                            <span class="text"><i class="ph ph-user-minus"></i> Block</span>
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-box-item-wrapper overflow-y-auto scroll-sm p-24" id="chat-container">
                        <div class="chat-box-item d-flex align-items-end gap-8">
                             <!-- <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0"> -->
                             <div class="chat-box-item__content">
                                 <div class="chat-box-item__text p-16 rounded-16 mb-12" id="chat-box">Hello {{ request.user.username }}, I am here to assist you</div>
                                 <!-- <p class="chat-box-item__text py-16 px-16 px-lg-4">Lorem ipsum dolor sit amet consectetur. Cursus vulputate eget ullamcorper bibendum pulvinar sed at libero. Vulputate amet fermentum sapien amet tempus ac donec.</p> -->
                                 <span class="text-gray-200 text-13 mt-2 d-block">10 min ago</span>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer border-top border-gray-100">
                    <form action="#" class="flex-align gap-8 chat-box-bottom">
                        <label for="fileUp" class="flex-shrink-0 file-btn w-48 h-48 flex-center bg-main-50 text-24 text-main-600 rounded-circle hover-bg-main-100 transition-2">
                            <i class="ph ph-plus"></i>
                        </label>
                        <input type="file" name="fileName" id="fileUp" hidden>
                        <input type="text" id="chat-input" class="form-control h-48 border-transparent px-20 focus-border-main-600 bg-main-50 rounded-pill placeholder-15" placeholder="Type your message...">
                        <button type="button" class="flex-shrink-0 file-btn w-48 h-48 flex-center bg-main-50 text-24 text-main-600 rounded-circle hover-bg-main-100 transition-2">
                            <i class="ph-fill ph-microphone"></i>
                        </button>
                        <button onclick="sendChat()" class="flex-shrink-0 submit-btn btn btn-main rounded-pill flex-align gap-4 py-15">
                            Submit <span class="d-flex text-md d-sm-flex d-none"><i class="ph-fill ph-paper-plane-tilt"></i></span> 
                        </button>
                    </form>
                </div>
            </div>
            <!-- chat sidebar End -->
        </div>
         
    </div>
    <div class="dashboard-footer">
<div class="flex-between flex-wrap gap-16">
    <p class="text-gray-300 text-13 fw-normal"> &copy; Copyright Exampro 2024, All Right Reserverd</p>
    <div class="flex-align flex-wrap gap-16">
        <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">License</a>
        <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">admin</a>
        <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">Documentation</a>
        <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">Support</a>
    </div>
</div>
</div>
</div>

        
        <!-- Jquery js -->
    <script src="{% static 'assets/js/jquery-3.7.1.min.js'%}"></script>
    <!-- Bootstrap Bundle Js -->
    <script src="{% static 'assets/js/boostrap.bundle.min.js'%}"></script>
    <!-- Phosphor Js -->
    <script src="{% static 'assets/js/phosphor-icon.js'%}"></script>
    <!-- file upload -->
    <script src="{% static 'assets/js/file-upload.js'%}"></script>
    <!-- file upload -->
    <script src="{% static 'assets/js/plyr.js'%}"></script>
    <!-- dataTables -->
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <!-- full calendar -->
    <script src="{% static 'assets/js/full-calendar.js'%}"></script>
    <!-- jQuery UI -->
    <script src="{% static 'assets/js/jquery-ui.js'%}"></script>
    <!-- jQuery UI -->
    <script src="{% static 'assets/js/editor-quill.js'%}"></script>
    <!-- apex charts -->
    <script src="{% static 'assets/js/apexcharts.min.js'%}"></script>
    <!-- jvectormap Js -->
    <script src="{% static 'assets/js/jquery-jvectormap-2.0.5.min.js'%}"></script>
    <!-- jvectormap world Js -->
    <script src="{% static 'assets/js/jquery-jvectormap-world-mill-en.js'%}"></script>
    
    <!-- main js -->
    <script src="{% static 'assets/js/main.js'%}"></script>


    <script>
        async function sendChat() {
            const input = document.getElementById("chat-input");
            const chatBoxWrapper = document.getElementById("chat-container");
        
            const message = input.value.trim();
            if (!message) return;
        
            const userMessage = `
            <div class="chat-box-item d-flex align-items-end gap-8 justify-content-end">
                <div class="chat-box-item__content text-end">
                    <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-main-600 text-white">${message}</div>
                    <span class="text-gray-200 text-13 mt-2 d-block text-end">Just now</span>
                </div>
                <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0">
            </div>`;
        
            chatBoxWrapper.innerHTML += userMessage;
            input.value = "";
        
            // Show typing indicator
            const botTyping = document.createElement("div");
            botTyping.className = "chat-box-item d-flex align-items-end gap-8 bot-typing";
            botTyping.innerHTML = `
                <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0">
                <div class="chat-box-item__content">
                    <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-main-100 text-gray-600">
                        <em>Typing...</em>
                    </div>
                </div>`;
            chatBoxWrapper.appendChild(botTyping);
            chatBoxWrapper.scrollTop = chatBoxWrapper.scrollHeight;
        
            try {
                const res = await fetch("/api/groq-chat/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message })
                });
        
                const data = await res.json();
                botTyping.remove();  // Remove typing indicator
        
                const botMessage = `
                <div class="chat-box-item d-flex align-items-end gap-8">
                    <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0">
                    <div class="chat-box-item__content">
                        <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-main-100 text-gray-600">${data.reply}</div>
                        <span class="text-gray-200 text-13 mt-2 d-block">Just now</span>
                    </div>
                </div>`;
                chatBoxWrapper.innerHTML += botMessage;
        
            } catch (err) {
                botTyping.remove();  // Remove typing indicator
                const errorMessage = `
                <div class="chat-box-item d-flex align-items-end gap-8">
                    <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" alt="" class="w-40 h-40 rounded-circle object-fit-cover flex-shrink-0">
                    <div class="chat-box-item__content">
                        <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-danger text-white">‚ö†Ô∏è Sorry, something went wrong.</div>
                    </div>
                </div>`;
                chatBoxWrapper.innerHTML += errorMessage;
            }
        
            chatBoxWrapper.scrollTop = chatBoxWrapper.scrollHeight;
        }
        </script>
        <script>
            let recognition;
            let recognizing = false;
            
            function initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("Sorry, your browser doesn't support Speech Recognition.");
                    return;
                }
            
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
            
                recognition.onstart = () => {
                    recognizing = true;
                    console.log("Voice recognition started...");
                };
            
                recognition.onend = () => {
                    recognizing = false;
                    console.log("Voice recognition ended.");
                };
            
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById("chat-input").value = transcript;
                    sendChat();  // Auto-send after speaking
                };
            
                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                };
            }
            
            document.addEventListener("DOMContentLoaded", () => {
                initSpeechRecognition();
            
                document.querySelector(".ph-microphone").addEventListener("click", (e) => {
                    e.preventDefault();
                    if (recognition && !recognizing) {
                        recognition.start();
                    } else if (recognition && recognizing) {
                        recognition.stop();
                    }
                });
            });
            </script>
            <script>document.getElementById("fileUp").addEventListener("change", async function (e) {
                const file = e.target.files[0];
                if (!file) return;
            
                const formData = new FormData();
                formData.append("file", file);
            
                const chatBoxWrapper = document.getElementById("chat-container");
            
                chatBoxWrapper.innerHTML += `
                    <div class="chat-box-item d-flex align-items-end justify-content-end">
                        <div class="chat-box-item__content text-end">
                            <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-main-600 text-white">
                                üì§ Uploaded file: ${file.name}
                            </div>
                        </div>
                    </div>
                `;
            
                const loader = document.createElement("div");
                loader.innerHTML = `<div class="chat-box-item"><div class="chat-box-item__text bg-main-100">üß† Thinking...</div></div>`;
                chatBoxWrapper.appendChild(loader);
            
                try {
                    const response = await fetch("/api/groq-chat-file/", {
                        method: "POST",
                        body: formData,
                    });
                    const data = await response.json();
                    loader.remove();
            
                    chatBoxWrapper.innerHTML += `
                        <div class="chat-box-item d-flex align-items-end gap-8">
                            <img src="{% static 'assets/images/thumbs/avatar-img1.png'%}" class="w-40 h-40 rounded-circle" />
                            <div class="chat-box-item__content">
                                <div class="chat-box-item__text p-16 rounded-16 mb-12 bg-main-100 text-gray-600">
                                    ${data.reply}
                                </div>
                            </div>
                        </div>
                    `;
                    chatBoxWrapper.scrollTop = chatBoxWrapper.scrollHeight;
                } catch (err) {
                    loader.remove();
                    alert("Error uploading file.");
                }
            });
            </script>
                
            

    </body>
</html>